<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Lab 3 - Choropleth Map </title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/business-casual.css" rel="stylesheet">

    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="font-awesome/css/font-awesome-animation.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Josefin+Slab:100,300,400,600,700,100italic,300italic,400italic,600italic,700italic" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <div class="brand">Lab 3. Choropleth Map</div>
    <div class="address-bar">GES 387 - Interactive Cartography</div>

    <div class="container">

        <div class="row">
            <div class="box">
                <!--<div class="col-lg-12">
                    <hr>
                    <h2 class="intro-text text-center">
                        <strong>blog</strong>
                    </h2>
                    <hr>
                </div>-->
                <div class="col-lg-12 text-center" style="text-align:left">
                  <h3>Overview</h3>
                        <p><i class="fa fa-spinner fa-spin"></i>  In this lab, we will create a choropleth map using GeoJSON data.</p>
                        <p><i class="fa fa-spinner fa-spin"></i>  Please submit your assignment via <b>Dropbox on D2L</b> according to the requirements in the <a href="#hw"><b>Deliverables</b></a> section at the bottom.</p>
                        <p style="color:red"><b><i class="fa fa-spinner fa-spin"></i>  Due: 11:59 pm, Wednesday, 10/12 (I extended the deadline so you have two weeks)</b></p>



                    <h3><i class="fa fa-paint-brush"></i> Set up basemap</h3>
                    <ul>
                           <li>Before you start, create a <b>new file folder</b> (e.g., lab3) for this lab.</li>
                           <li>If you need to download the leaflet files, download the zip folder from <a href="https://drive.google.com/file/d/0BzvZaHCgmEmNRDZXWkt2aXNTNUk/view?usp=sharing" target="_blank" style="font-weight:bold">here</a>. </li>

                            <li>Open your <b>html editor</b> (e.g., <b>Atom</b>) and add the following lines to set up the basemap using the Mapbox light canvas.<br><br>
                            Note you may need to <b>modify the red part</b> if you want to use relative url to point to the leaflet files stored in a different folder. And replace the <b>access token</b> (Check the <a href="https://neiugis.github.io/lab1/hint/mapbox.html" target="_blank">instructions</a> if in doubt).<br>
                           <pre>
&lt;!DOCTYPE html&gt;
&lt;html&gt;
   &lt;head&gt;
       &lt;title&gt;Lab 3&lt;/title&gt;
       &lt;link rel="stylesheet" href="<span style="color:red">leaflet.css</span>" /&gt;
       &lt;script src="<span style="color:red">leaflet.js</span>"&gt;&lt;/script&gt;

   &lt;/head&gt;

   &lt;body&gt;
       &lt;div id="map" style="height: 550px; "&gt;&lt;/div&gt;

       &lt;script type="text/javascript"&gt;
         var map = L.map('map').setView([51.48,-0.07], <span style="color:blue">10</span>);

         L.tileLayer(<span class="hljs-string" style="color:#cc6600">'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}'</span>, {
           attribution: <span class="hljs-string" style="color:#cc6600">'Map data &amp;copy; </span><span class="text-cut" data-cut="[…]"style="color:#cc6600"><span class="hljs-string"style="color:#cc6600">&lt;a href="http://openstreetmap.org"&gt;OpenStreetMap&lt;/a&gt; contributors, &lt;a href="http://creativecommons.org/licenses/by-sa/2.0/"&gt;CC-BY-SA&lt;/a&gt;, Imagery © &lt;a href="http://mapbox.com"&gt;Mapbox&lt;/a&gt;</span></span><span class="hljs-string">'</span>,
           maxZoom: <span class="hljs-number" style="color:blue">11</span>,
           minZoom: <span class="hljs-number" style="color:blue">5</span>,
           id: <span class="hljs-string">'</span>mapbox.light<span class="hljs-string">'</span>,
           accessToken: <span class="hljs-string">'</span><span class="hljs-string" style="color:red">your mapbox public access token</span><span class="hljs-string">'</span>
         }).addTo(map);

       &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre>
                           Then, save the document as <code>map3.html</code> in your lab3 folder. Please remember to specify the file extension as <b>.html</b> to make it work. If you did everything right, your map should look like:<br>
                           <iframe src="map/basemap.html" width=100% height=520  frameborder=0></iframe><br><br>
Yep, we will map London this time! You will get the London Boroughs shapefile below.
                    </li></ul>


             <h3><i class="fa fa-paint-brush"></i>Prepare and add GeoJSON layer</h3>
                    <p>In Lab 2, we have introduced how to add markers to your map <b>manually</b> using their geographic coordinates. But you may wish to work with more complex spatial features as in a desktop GIS. So we introduce GeoJSON, which is a <strong>format</strong> for encoding a variety of geographic data structures (<a href="http://geojson.org" target="_blank">http://geojson.org</a>).</p>
                    <ul>

                        <li style="font-weight:bold;color:red;"> Getting Data: click <a href="https://drive.google.com/open?id=0BzvZaHCgmEmNU09QLTluZFFpVkU" target="_blank">here</a> to download the shapefile used in this lab (You are welcome to use your own data). </li>
                        <li>Unzip the data to your desired directory.</li>

                            <li>Launch <strong>QGIS Desktop</strong> (available in both BBH242 and BBH252; It is open source and cross-platform so you can <a href="http://www.qgis.org/en/site/forusers/download.html" target=_blank>download it</a> and install QGIS on your own computer) and go to <b>Layer (top menu bar) &gt; Add Layer &gt; Add Vector Layer</b> (I use QGIS 2.14. If you have a newer or older version QGIS, the menu organization may be different). Then browse to the directory where you have unzipped the shapefile and select the <b>london_borough.shp</b> file to open it in QGIS. The shapefile also contains three fields in their attribute table: <b>NAME, pop_den (population density), and per_indian (percent Indian population)</b>. You can take a look by right-clicking the layer name and select <b>Open Attribute Table</b>.</li>

                              <li>To maximize the rendering speed, there are two imporant steps we should always perform in QGIS before exporting a shapefile to GeoJSON: (1) simplify geometry; and (2) delete unwanted fields in the attribute table. For your convenience, I have already deleted the unrelevant fields. But you still need to simplify the geometry, please follow the step below: <br><br>
                        &nbsp;In QGIS, go to <b>Vector &gt; Geometry Tools &gt; Simplify Geometries</b>, use london_borough as Input. For the Simplify tolerance, the unit is the same as the unit of the reference system (In our case, the unit is meter). Vertices are removed if the distance with the tentative simplified line is smaller than the tolerance. Therefore, higher tolerance values would generate simpler features (smaller file size) but also lose some details. Let's use <b>0.2</b> here (see image below).<br><br>
  <center><img src="img/simplify.png" width=37% align="middle" ></img></center>
                        </li>
                        <li>Click OK to run. Once the process is complete, you will see a dialog window telling you how many vertices have been eliminated.</li>
                        <li>Next, in the Layers panel of QGIS, right-click the layer and select <b>Save As...</b>. In the dialog window, set Format to <b>GeoJSON</b>, click Browse to save output file to your lab data folder (any name you like), and be sure to set the CRS to <b>EPSG:4326 - WGS 84</b> (see image below). Then click OK to save the GeoJSON file. Then close QGIS (no need to save anything).<br><br>
                            <center><img src="img/qgis.png" width=80% ></img></center></li>
                        <li>Use <b>Atom</b> to open the GeoJSON file (similar to open an HTML document). Place the following at the very beginning of the GeoJSON document (see image below):
                            <pre><span style="color: blue">var</span> <var>data = </var></pre>
                          <center>  <img src="img/geojson.png" width=80% ></img></center></li>
                         <li>Save the changed GeoJSON as <code>data.js</code> to your <b>lab working folder (where your html file is saved)</b>. Note the file extension is <code>.js</code>.
                             <br>Here is a copy of the <a href="map/data.js" target="_blank">(data.js)</a> file I created.</li>
                        <li>Return to your HTML document. In the <code>head</code> section, include the following line so that we can use <code>data.js</code> for mapping:
                            <pre>&lt;script type="text/javascript" src=<span style="color:#cc6600">"data.js"</span>&gt;&lt;/script&gt;</pre></li>
                        <li>Then, in <code>script</code> section (inside <code>body</code>), include the following to add the data.
                            <pre>L.geoJson(<span style="color:#990099">data</span>).addTo(<span style="color:#990099">map</span>);</pre>
                        The GeoJSON data layer is now added to the map! Take a look at the <a href="map/geojsondata.txt" target="_blank">sample code</a> if needed.
                      <iframe src="map/geojsondata.html" height=570 width=100% frameborder=0></iframe></li>
                    </ul>


              <h3><i class="fa fa-paint-brush"></i> Add colors</h3>
                  <ul>
                        <li>Now, we will color the London Boroughs according to their population density. Remember the orignal shapefile contains three fields: NAME, pop_den, and per_indian. The population density data will come from the <code>pop_den</code>. </li>
                        <li>For choosing colors, Leaflet recommends <a href="http://colorbrewer2.org/" target="_blank">ColorBrewer</a>, where you can pick a color scheme and get the <a href="http://www.w3schools.com/html/html_colors.asp" target="_blank">HTML color codes</a> for the different colors. Let's use the 5-class Purples (For Question 2, you will use a different one):<br>
                            <img src="img/green.png"></img></li>
                        <li>Once we have the color codes, we need to create a function that returns a color based on population density values. Place the following lines <b>above</b> the line of <code>L.geoJson</code>):
                            <pre>function getColor(<span style="color:#990099">value</span>) {
    return <span style="color:#990099">value</span> &gt; <span style="color:blue">139</span> ? <span style="color:#cc6600">'#54278f'</span>:
           <span style="color:#990099">value</span> &gt; <span style="color:blue">87</span>  ? <span style="color:#cc6600">'#756bb1'</span>:
           <span style="color:#990099">value</span> &gt; <span style="color:blue">53</span>  ? <span style="color:#cc6600">'#9e9ac8'</span>:
           <span style="color:#990099">value</span> &gt; <span style="color:blue">32</span>  ? <span style="color:#cc6600">'#cbc9e2'</span>:
                         <span style="color:#cc6600">'#f2f0f7'</span>;
}</pre>
              In the above lines, the <span style="color:blue">blue colored numbers</span> are the <b>break values</b> that are used to classify the population density (in people/hectare) of the different London Boroughs. Try to classify your data in QGIS or ArcGIS may help determine the break values. Here, I used <code>Natural Breaks</code> as the classification method. You may have noticed the <span style="color:#cc6600">color codes</span> are used as well.
              <br><br>
              Let's try to take a close look at the fuction: if the value (population density) is <b>greater than 139</b> people/hectare, the darkest purple (<code>#54278f</code>) will be used. If the value is <b>less than 139 but greater than 87</b>, use the second dark purple (<code>#756bb1</code>), and so forth. The <b>question mark <code>?</code></b> and <b>colon <code>:</code></b> are used together to create a conditional statement (We will talk about this on Monday).
              <br><br>It is okay if you cannot fully understand this. If you use your own data, you will just need to replace the <b>break values</b> and <b>colors</b>. You can, of course, add or remove classes. Please follow the syntax carefully.</li>
                        <li>Following the <code>getColor</code> function, we define another function for the GeoJSON layer so that its <code>fillColor</code> depends on <code>feature.properties.pop_den</code> property:
<pre>function style(feature){
    return {
        fillColor: getColor(feature.properties.<span style="color:#990099">pop_den</span>),
        weight: <span style="color:blue">2</span>,
        opacity: <span style="color:blue">1</span>,
        color: <span style="color:#cc6600">'gray'</span>,
        fillOpacity: <span style="color:blue">0.9</span>
    };
}</pre>Note the <span style="color:#990099">pop_den</span> is the field name for the population density values. <br><br>For the function attributes, you may be able to tell what they do by their names, e.g., <code>fillColor</code> is to define the fillcolor of the features, <code>weight</code> is to define the weight of the boundary lines, etc. You may try to customize the appearance by adjusting the corresponding values.</li>
                        <li>To make the functions work, we have to <b>modify</b> the line of <code>L.geoJson</code> to:
                            <pre>L.geoJson(<span style="color:#990099">data</span>, {style:<span style="color:#990099">style</span>}).addTo(map);</pre>Please make sure the two functions are defined above <code>L.geoJson</code>.<br><br>
                        Now we have a map with colors (<a href="map/color.txt" target="_blank">sample code</a>) !
                        <iframe src="map/color.html" width=95% height=570 frameborder=0></iframe></li>
                    </ul>

             <h3><i class="fa fa-paint-brush"></i> Add legend</h3>
                <ul>
                          <li>Next, we will add legend to the map. In the <code>head</code> section of your html document, place the following lines to define the appearance of the legend (see the comment lines in red for explanations):
                        <pre>&lt;style&gt;
    <span style="color:red">/* Change the values below to adjust the appearance of the legend */</span>
    .legend {
        padding: 6px 8px;
        line-height: 18px;
        background: rgba(255,255,255,0.9);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
    }

     <span style="color:red">/* Change the values below to adjust the appearance of the legend color boxes */</span>
     .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
&lt;/style&gt;
</pre></li>
                    <li>Next, in the <code>script</code> section of <code>body</code>, add the following lines below <code>L.geoJson</code> to define how the legend will be created in your map (see the comment lines in red for explanation):
                        <pre>var legend = L.control({position: 'bottomright'}); <span style="color:red">// Try the other three corners if you like.</span>

legend.onAdd = function (map) {

    var div = L.DomUtil.create('div', 'legend'),
        grades = [<span style="color:blue">0, 32, 53, 87, 139</span>]; <span style="color:red">// The break values to define the intervals of population, note we begin from 0 here</span>

    div.innerHTML = <span style="color:#cc6600">'&lt;b&gt;Population Density &lt;br&gt; 2011 &lt;br&gt;&lt;/b&gt;'</span>; <span style="color:red">// The legend title, in this case it's Population Density 2011</span>

    <span style="color:red">// Loop through our the classes and generate a label with a colored square for each interval.
    // If you are creating a similar choropleth map, you do not need to change lines below. </span>
    for (var i = 0; i &lt; grades.length; i++) {
        div.innerHTML +=
        '&lt;i style="background:' + getColor(grades[i] + 1) + '"&gt;&lt;/i&gt;' +
        grades[i] + (grades[i + 1] ? '&amp;ndash;' + grades[i + 1] + '&lt;br&gt;' : '+');
    }

    return div;
};

legend.addTo(map);</pre>
                        The above functions for defining the legend may be too much for you to understand. But you can simply replace some small portions according to the comment lines when you answer question 3 or make your own maps.
                        <br><br>
                        The legend will be created at the bottom right corner of your map with the defined styles and content:
                          <iframe src="map/map.html" width=95% height=570 frameborder=0></iframe>
                    </li>

                </ul>
                <br>



                <br>
                <h2 >Deliverables (<a href="#top" style="font-weight:normal; text-decoration:underline">Back to Top <i class="fa fa-arrow-circle-up faa-float animated" aria-hidden="true"></i></a>)</h2>
                <p>Please turn in <b>a separate html file for each question</b> below via Dropbox on D2L. There will be <b>three</b> in total. You don't have to turn in the leaflet files as I will have them on my computer.</p>
                <ul id="hw">
                  <li><b>Question 1:</b> Submit the html file you have just completed by following along the instructions (9 pts).</li>
                  <li><b>Question 2:</b> Save the html file as <code>color.html</code>. Modify the code to use a <b>different color scheme</b> (<i>Hint: You will need to modify the color code used in the <code>getColor</code> function</i>) (6 pts). </li>
                  <li><b>Question 3:</b> Save the html file as <code>indian.html</code>. Modify the code to make another choropleth map with the <code>per_indian</code> (% Indian Population) field. For the break values, use <b>20, 15, 7.5, 3</b> (again, 5 classes) (<i>Hint: You will need to modify the break values used in the <code>getColor</code> function, then field name used for <code>fillColor</code> within the <code>style</code> function.) Please also remember to change the <b>legend</b> portion to reflect the percent Indian population data. </i>) (10 pts). </li>

                </ul><br>
                </div>
            </div>
        </div>
    </div>
    <!-- /.container -->


    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <p>Copyright &copy; Ting Liu 2016</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

</body>

</html>
